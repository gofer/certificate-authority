#!/bin/sh

# 環境の読み出し
if [ -f "$(dirname $0)/.env" ]; then
  source $(dirname $0)/.env
fi

# 設定ファイルのディレクトリ
CONFIG_DIR=${CONFIG_DIR:=.}

# 初期化
root_ca_dir='/etc/ssl/root_ca'
ca_dir='/etc/ssl/inter_ca'

# ドメイン名(DN; Distinguished Name)
DN='apps.localdomain'
SUBJECT="/C=JP/CN=${DN}"
SAN="DNS:${DN},DNS:app1.apps.localdomain"

# パスフレーズ読み取り
PASSWORD=''
read -s -p "Passphrase: " PASSWORD
echo ''

# 鍵生成
openssl genrsa \
  -batch \
  -passout "pass:${PASSWORD}" \
  -out "${DN}.private_key.pem" \
  -aes-256-cbc \
  4096

if [ $? -ne 0 ]; then
  echo 'Failed to generate ras key.' > /dev/stderr
  exit 1
fi

openssl rsa \
  -passin "pass:${PASSWORD}" \
  -in "${DN}.private_key.pem" \
  -out "${DN}.private_key.nopass.pem" \


# リクエスト
openssl req -new -utf8 \
  -batch \
  -subj "${SUBJECT}" \
  -addext "subjectAltName = ${SAN}" \
  -passin "pass:${PASSWORD}" \
  -key "${DN}.private_key.pem" \
  -out "${DN}.csr"

if [ $? -ne 0 ]; then
  echo 'Failed to generate requeset.' > /dev/stderr
  exit 1
fi

# 確認
# openssl req -noout -text -in "${DN}.csr"

# 署名
openssl ca \
  -config "${CONFIG_DIR}/openssl.cfg" \
  -section CA_inter \
  -md sha256 \
  -days 366 \
  -passin "pass:${PASSWORD}" \
  -keyfile "${ca_dir}/private/private_key.pem" \
  -cert "${ca_dir}/certs/inter_ca.crt" \
  -in "${DN}.csr" \
  -out "${DN}.crt"

# 確認
# openssl x509 -noout -text -in "${DN}.crt"


# チェーン生成
openssl crl2pkcs7 \
  -nocrl \
  -certfile "${DN}.crt" \
  -certfile "${ca_dir}/certs/inter_ca.crt" \
  -certfile "${root_ca_dir}/certs/root_ca.crt" \
  -out "${DN}.chain.p7b"


cat "${DN}.crt" > "${DN}.chain.crt"
cat "${ca_dir}/certs/inter_ca.crt" >> "${DN}.chain.crt"
cat "${root_ca_dir}/certs/root_ca.crt" >> "${DN}.chain.crt"
